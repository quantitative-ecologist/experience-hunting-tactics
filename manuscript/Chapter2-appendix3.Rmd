---
title: |
     Hunting experience shapes individual foraging specialisation and predator-prey interactions in an online videogame: \
    Appendix 3
output: 
  word_document:
    reference_docx: Chapter2-styles.docx
    fig_caption: yes
bibliography: references.bib
csl: ecology.csl
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(data.table)
library(brms)
library(flextable)
library(officer)
library(tidyr)

```

\newpage

```{r tableS1, ft.align = "left"}

# ===========================================================================
# 1. Import the model fit
# ===========================================================================


# path
path <- file.path(here::here("outputs"))

# Import the model
fit <- readRDS(
  file.path(path, "01_outputs_models", "B1_DHMLM.rds")
)

# ===========================================================================
# ===========================================================================





# ===========================================================================
# 2. Fixed effects table
# ===========================================================================


# Prepare the table ---------------------------------------------------------

# Extract the fixed effects from the model
eff_tab <- data.table(fixef(fit), keep.rownames = TRUE)
eff_tab <- eff_tab[, c(1, 2, 4:5)]

# Rename variables
setnames(
  eff_tab,
  c("rn", "Q2.5", "Q97.5"),
  c("parameter", "lower_ci", "upper_ci")
)

# Add a column that specifies the experience level
eff_tab[parameter %like% "novice", xp_level := "novice"]
eff_tab[parameter %like% "interm", xp_level := "intermediate"]
eff_tab[parameter %like% "advanced", xp_level := "advanced"]

# Back transform success
eff_tab[
  parameter %like% "success",
  c(2:4) := lapply(.SD, function(x) {plogis(x)}),
  .SDcols = c(2:4)
]

# Back transform sigma
eff_tab[
  parameter %like% "sigma",
  c(2:4) := lapply(.SD, function(x) {exp(x)}),
  .SDcols = c(2:4)
]

# Round values to 3 digits
eff_tab[, c(2:4) := round(eff_tab[, c(2:4)], digits = 3)]



# Reorganize the table ------------------------------------------------------

# reorder columns, and then rows based on xp level
eff_tab <- eff_tab[, c(5, 1:4)]
setorder(
  eff_tab,
  cols = -"xp_level"
)

# Create trait column
eff_tab[
  , trait := rep(c(
    "predator speed", "predator speed",
    "prey speed", "prey speed", "hunting success"),
    6
  )
]

# Rename parameter
eff_tab[
   , parameter := rep(
      c(
         rep(c("intercept (mean)", "intercept (sigma)"), 2),
         "intercept (mean)",
         rep(c("prey rank (mean)", "prey rank (sigma)"), 2),
         "match duration (mean)"
      ),
      3
   )
]

# Paste upper and lower ci with estimate
eff_tab[, estimate := paste(format(Estimate, digits = 3), "(")]
eff_tab[, estimate := paste(estimate, format(lower_ci, digits = 3), sep = "")]
eff_tab[, estimate := paste(estimate, ",", sep = "")]
eff_tab[, estimate := paste(estimate, format(upper_ci, digits = 3), sep = " ")]
eff_tab[, estimate := paste(estimate, ")", sep = "")]
eff_tab[, c("Estimate", "lower_ci", "upper_ci") := NULL]


# Reshape
eff_tab <- dcast(
  eff_tab,
  trait + parameter ~ xp_level,
  value.var = "estimate"
)

# Reorder columns
eff_tab <- eff_tab[, c(1, 2, 5, 4, 3)]

# Reorder rows
table <- eff_tab[c(3, 5, 4, 6, 7, 9, 8, 10, 1, 2)]

# Because I can't align hunting success properly
table[10, 1] <- " "

# ===========================================================================
# ===========================================================================





# ===========================================================================
# 3. Create the table using flextable
# ===========================================================================

# Prepare the table parameters ----------------------------------------------

# Custom header
my_header <- data.frame(
  col_keys = c("trait", "parameter",
               "novice", "intermediate", "advanced"),
  line1 = c("Trait",
            "Parameter",
            "Novice",
            "Intermediate",
            "Advanced"),
  stringsAsFactors = FALSE
)

# Custom theme
my_theme <- function(x, ...) {
  x <- colformat_double(x, big.mark = " ",
                        decimal.mark = ".",
                        digits = 3)
  x <- set_table_properties(x, layout = "fixed")
  x <- border_remove(x)
  std_border <- fp_border(width = 1, color = "black")
  x <- hline_top(x, part = "all", border = std_border)
  x <- hline_bottom(x, part = "all", border = std_border)
  autofit(x)
}



# Create the table ----------------------------------------------------------

tab2 <-

  # table structure
  table %>%
  select(trait, parameter,
         novice, intermediate, advanced) %>%
  flextable(col_keys = my_header$col_keys) %>%
  set_header_df(mapping = my_header, key = "col_keys") %>%
  my_theme() %>%

  # Align repeated rows on column 1
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top", part = "body") %>%

  # Align text
  align(align = "left", part = "all", j = 1) %>%
  align(align = "left", part = "all", j = 2) %>%
  align(align = "center", part = "all", j = 3) %>%
  align(align = "center", part = "all", j = 4) %>%
  align(align = "center", part = "all", j = 5) %>%

  # Footnote
  footnote(
    i = 1, j = 1,
    part = "header",
    value = as_paragraph(
      as_sup("a "),
      "We exponentiated the dispersion parameters (i.e. sigma) which are estimated on a log scale. We back-transformed the hunting success values, estimated on a logit scale, back to a probability scale.",
      as_sup("\nb "),
      "The intercept values on the mean part of the equation for all traits indicate mean behaviour and success at the population level. The intercept values on the dispersion (i.e. sigma) part of the equation for predator speed indicate behavioural specialization at the population level."
    ),
    ref_symbols = " "
  ) %>%

  # Table caption
  set_caption(
    caption = "Table S1. Posterior means and 95% credible intervals of the fixed effects estimated by the MDHGLM of predator speed, prey speed, and predator hunting success.",
    style = "Table Caption"
  ) %>%

  # Font options
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 10, part = "all") %>%
  fontsize(size = 12, part = "footer") %>%
  width(j = c(2, 3, 4, 5), width = 3.7, unit = "cm") %>%
  width(j = 1, width = 3.2, unit = "cm")


tab2

# ===========================================================================
# ===========================================================================

```

\newpage

```{r tableS2, ft.align = "left"}

# ===========================================================================
# 1. Import the model fit
# ===========================================================================

# path
path <- file.path(here::here("outputs"))

# Import the model
fit <- readRDS(
  file.path(path, "01_outputs_models", "B1_DHMLM.rds")
)

# ===========================================================================
# ===========================================================================





# ===========================================================================
# 2. Random effects table
# ===========================================================================


# Prepare data --------------------------------------------------------------

# Extract the random effect variances
sd_draws <- data.table(
   as_draws_df(
      fit, variable = "^sd_", regex = TRUE
   )
)

sd_draws[, c(28:30) := NULL]



# Calculate parameters -------------------------------------------------------

# Take the exponent of sigma parameters
sd_draws[
   , c("sd_predator_id__sigma_speednovice_Intercept",
       "sd_predator_id__sigma_speedinterm_Intercept",
       "sd_predator_id__sigma_speedadvanced_Intercept",
       "sd_predator_id__sigma_preyspeednovice_Intercept",
       "sd_predator_id__sigma_preyspeedinterm_Intercept",
       "sd_predator_id__sigma_preyspeedadvanced_Intercept"
   )
   := lapply(.SD, function(x) {exp(x)}),
   .SDcols = c(
      "sd_predator_id__sigma_speednovice_Intercept",
      "sd_predator_id__sigma_speedinterm_Intercept",
      "sd_predator_id__sigma_speedadvanced_Intercept",
      "sd_predator_id__sigma_preyspeednovice_Intercept",
      "sd_predator_id__sigma_preyspeedinterm_Intercept",
      "sd_predator_id__sigma_preyspeedadvanced_Intercept"
   )
]



# Reshape the table -----------------------------------------------------------

ranef_tab <- melt(
   sd_draws,
   variable.name = "parameter"
)



# Summarize the values (means + 95% CI) --------------------------------------

# Intervals
lower_interval <- function(x) {
  coda::HPDinterval(as.mcmc(x), 0.95)[1]
}
upper_interval <- function(x) {
  coda::HPDinterval(as.mcmc(x), 0.95)[2]
}


# Summarize values
ranef_tab[, ":=" (mean = mean(value),
                  lower_ci = lower_interval(value),
                  upper_ci = upper_interval(value)),
          by = .(parameter)]

ranef_tab <- unique(ranef_tab[, .(parameter, mean, lower_ci, upper_ci)])
ranef_tab[, c(2:4) := round(ranef_tab[, c(2:4)], 3)]



# Rearrange the table --------------------------------------------------------

# Add a column that specifies the experience level
ranef_tab[parameter %like% "novice", xp_level := "novice"]
ranef_tab[parameter %like% "interm", xp_level := "intermediate"]
ranef_tab[parameter %like% "advanced", xp_level := "advanced"]


# Paste upper and lower ci with estimate
ranef_tab[, estimate := paste(format(mean, digits = 3), "(")]
ranef_tab[, estimate := paste(estimate, format(lower_ci, digits = 3), sep = "")]
ranef_tab[, estimate := paste(estimate, ",", sep = "")]
ranef_tab[, estimate := paste(estimate, format(upper_ci, digits = 3), sep = " ")]
ranef_tab[, estimate := paste(estimate, ")", sep = "")]
ranef_tab[, c("mean", "lower_ci", "upper_ci") := NULL]

# Parameter column
ranef_tab[
   , parameter1 := ifelse(
       parameter %like% "predator_id__sigma",
       "predator ID (sigma)",
       "predator ID (mean)"
   )
]
ranef_tab[parameter %like% "avatar", parameter1 := "avatar (mean)"]
ranef_tab[parameter %like% "env", parameter1 := "environment (mean)"]

# Trait column
ranef_tab[
   , trait := ifelse(
       parameter %like% "preyspeed",
       "prey speed",
       "predator speed"
   )
]
ranef_tab[parameter %like% "success", trait := "hunting success"]

# Remove old parameter column and replace by new
ranef_tab[, parameter := NULL]
setnames(ranef_tab, "parameter1", "parameter")

# Reshape
ranef_tab <- dcast(
   ranef_tab,
   trait + parameter ~ xp_level,
   value.var = "estimate"
)

# Reorder columns
ranef_tab <- ranef_tab[, c(1, 2, 5, 4, 3)]

# Reorder rows
table <- ranef_tab[c(1:5, 6:9)]

# ===========================================================================
# ===========================================================================





# ===========================================================================
# 3. Create the table using flextable
# ===========================================================================

# Prepare the table parameters ----------------------------------------------

# Custom header
my_header <- data.frame(
  col_keys = c("trait", "parameter",
               "novice", "intermediate", "advanced"),
  line1 = c("Trait",
            "Parameter",
            "Novice",
            "Intermediate",
            "Advanced"),
  stringsAsFactors = FALSE
)

# Custom theme
my_theme <- function(x, ...) {
  x <- colformat_double(x, big.mark = " ",
                        decimal.mark = ".",
                        digits = 3)
  x <- set_table_properties(x, layout = "fixed")
  x <- border_remove(x)
  std_border <- fp_border(width = 1, color = "black")
  x <- hline_top(x, part = "all", border = std_border)
  x <- hline_bottom(x, part = "all", border = std_border)
  autofit(x)
}



# Create the table ----------------------------------------------------------

tab3 <-

  # table structure
  table %>%
  select(trait, parameter,
         novice, intermediate, advanced) %>%
  flextable(col_keys = my_header$col_keys) %>%
  set_header_df(mapping = my_header, key = "col_keys") %>%
  my_theme() %>%

  # Align repeated rows on column 1
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top", part = "body") %>%
  # font
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%

  # Align text
  align(align = "left", part = "all", j = 1) %>%
  align(align = "left", part = "all", j = 2) %>%
  align(align = "center", part = "all", j = 3) %>%
  align(align = "center", part = "all", j = 4) %>%
  align(align = "center", part = "all", j = 5) %>%

  # Add footnote
  footnote(
    i = 1, j = 1,
    part = "header",
    value = as_paragraph(
      as_sup("a "),
      "We exponentiated the dispersion parameters (i.e. sigma) which are estimated on a log scale. All the reported values are standard deviations.",
      as_sup("\nb "),
      "The intercept values on the mean part of the equation for all traits indicate among individual differences in mean behaviour and success.",
      as_sup("\nc "),
      "The intercept values on the dispersion (i.e. sigma) part of the equation for predator speed indicate among individual differences in behavioural specialization. For prey speed and hunting success, they indicate among individual differences in the variability of prey encounters and variability in hunting success, respectively."
    ),
    ref_symbols = " "
  ) %>%

  # Add table caption
  set_caption(
    caption = "Table 3. Posterior means and 95% credible intervals of the random effects estimated by the MDHGLM of predator speed, prey speed, and predator hunting success.",
    style = "Table Caption"
  ) %>%

  # Font options
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 10, part = "all") %>%
  fontsize(size = 12, part = "footer") %>%
  width(j = c(2, 3, 4, 5), width = 3.7, unit = "cm") %>%
  width(j = 1, width = 3.2, unit = "cm")

tab3

# ===========================================================================
# ===========================================================================

```



```{r figS3, out.width = "100%", fig.cap = "**Figure S4.** Posterior median differences and 95% credible intervals between the parameter values of each predator experience level predicted by the MDHGLM. The test is displayed on the y axis (i.e. whether the group of interest has either a greater or smaller value), and the parameter value is displayed on the x axis. Each panel represent the experience level groups that are being compared."}

knitr::include_graphics(
    here::here(
        "outputs", "04_outputs_figures",
        "appendix3_figureS1.png"
    )
)

```
