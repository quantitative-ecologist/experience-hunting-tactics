---
title: |
     Hunting experience shapes individual foraging specialisation and predator-prey interactions in an online videogame: \
     Appendix 1
    
output: 
  word_document:
    reference_docx: Chapter2-styles.docx
    fig_caption: yes
bibliography: references.bib
csl: ecology.csl
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(data.table)
library(brms)
library(flextable)
library(officer)
library(tidyr)

```


```{r tableprep, include = FALSE}

# ===========================================================================
# 1. Extract the fixed effects from the MV model
# ===========================================================================

# Prepare the table ---------------------------------------------------------

# Model fit
fit <- readRDS(
  here::here("outputs", "01_outputs_models", "B2_DHMLM.rds")
)

# Fixed effects table
results <- data.table(
  round(summary(fit)$fixed, digits = 3)[, 1:4],
  keep.rownames = TRUE
)

setnames(results, "rn", "parameter")

results[parameter %like% "predspeed", trait := "predator speed"][
  parameter %like% "preyavgspeed", trait := "prey speed"][
    parameter %like% "success", trait := "hunting success"
  ]

# mu parameters table
tabs1 <- results[
    !(parameter %like% "sigma"),
    c(6, 1, 2, 4, 5)
]

# sigma parameters table
tabs2 <- results[
    parameter %like% "sigma",
    c(6, 1, 2, 4, 5)
]



# Rename parameter values ---------------------------------------------------

# Rename
tabs1[,
  parameter := c(
    rep(
      c("prey rank",
        "cumulative experience",
        "group 1",
        "group 4",
        "group 2",
        "group 3"),
      2
    ),
      c("game duration",
        "cumulative experience",
        "group 1",
        "group 4",
        "group 2",
        "group 3")
  )
]
# Reorder rows
tabs1 <- tabs1[
  c(1:3, 5, 6, 4,
    7:9, 11, 12, 10,
    13:15, 17, 18, 16)
]

# Rename
tabs2[,
  parameter := rep(
    c("prey rank",
      "cumulative experience",
      "group 1",
      "group 4",
      "group 2",
      "group 3"),
    2
  )
]

# Reorder
tabs2 <- tabs2[
  c(1:3, 5, 6, 4,
    7:9, 11, 12, 10)
]

# ===========================================================================
# ===========================================================================





# ===========================================================================
# 2. Compute the table using flextable
# ===========================================================================

# Prepare the table parameters ----------------------------------------------

# Custom header
my_header <- data.frame(
   col_keys = c("trait",
                "parameter",
                "Estimate",
                "l-95% CI",
                "u-95% CI"),
   line1 = c("Trait",
             "Parameter",
             "Value",
             "lower 95% CI",
             "upper 95% CI"),
   stringsAsFactors = FALSE
)

# Custom theme
my_theme <- function(x, ...) {
   x <- colformat_double(x, big.mark = " ",
                         decimal.mark = ".",
                         digits = 2)
   x <- set_table_properties(x, layout = "fixed")
   x <- border_remove(x)
   std_border <- fp_border(width = 1, color = "black")
   x <- hline_top(x, part = "all", border = std_border)
   x <- hline_bottom(x, part = "all", border = std_border)
   autofit(x)
}

```

\newpage

```{r tables1, ft.align = "left"}
# Create the table ----------------------------------------------------------

tabs1f <- tabs1 %>%
  flextable(col_keys = my_header$col_keys) %>%
  set_header_df(mapping = my_header, key = "col_keys") %>%
  my_theme() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top", part = "body") %>%
  align(align = "left", part = "all", j = c(1, 2)) %>%
  align(align = "center", part = "all", j = 3) %>%
  align(align = "center", part = "all", j = 4) %>%
  align(align = "center", part = "all", j = 5) %>%
  footnote(
    i = 1, j = 1,
    part = "header",
    value = as_paragraph(
      as_sup("a "),
      "Group 1: <50 matches, Group 2: between 50 and 99 matches, Group 3: between 100 and 299 matches, Group 4: > 299"
    ),
    ref_symbols = " "
  ) %>%
  set_caption(
    tabs1,
    caption = "Fixed effects table on the mean part of the model",
    style = "Table Caption"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  fontsize(size = 12, part = "footer") %>%
  font(fontname = "Times New Roman", part = "all")

tabs1f

# ===========================================================================
# ===========================================================================

```

\newpage

```{r tableS2, ft.align = "left"}

tabs2f <- tabs2 %>%
  flextable(col_keys = my_header$col_keys) %>%
  set_header_df(mapping = my_header, key = "col_keys") %>%
  my_theme() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top", part = "body") %>%
  align(align = "left", part = "all", j = c(1, 2)) %>%
  align(align = "center", part = "all", j = 3) %>%
  align(align = "center", part = "all", j = 4) %>%
  align(align = "center", part = "all", j = 5) %>%
  footnote(
    i = 1, j = 1,
    part = "header",
    value = as_paragraph(
      as_sup("a "),
      "Group 1: <50 matches, Group 2: between 50 and 99 matches, Group 3: between 100 and 299 matches, Group 4: > 299"
    ),
    ref_symbols = " "
  ) %>%
  set_caption(
    tabs2,
    caption = "Fixed effects table on the dispersion part of the model",
    style = "Table Caption"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  fontsize(size = 12, part = "footer") %>%
  font(fontname = "Times New Roman", part = "all")

tabs2f

```

\newpage

```{r figS1, out.width = "100%", fig.cap = "**Figure S1.** Among individual differences in the development of hunting expertise. The predators' hunting success (i.e. the probability of capturing the four prey) is on the y axis, and the predators' cumulative experience (i.e. the number of matches played prior to each observation) is on the x axis. Each fitted curve represents an individual predator. (A) Individuals with the greatest increase in hunting success with experience (B) Individuals with the greatest decrease in hunting success with experience."}

knitr::include_graphics(
  here::here(
    "outputs", "04_outputs_figures",
    "appendix1_figureS1.png"
  )
)

```


```{r figS2, out.width = "100%", fig.cap = "**Figure S2.** Distribution of the intra individual behavioural variation (i.e. specialization) of predators with the greatest increase in hunting success (A and B) and greatest decrease (C and D) in hunting success when they were novices (A and C) and then (B and D) advanced hunters."}

knitr::include_graphics(
  here::here(
    "outputs", "04_outputs_figures",
    "appendix1_figureS2.png"
  )
)

```


```{r figS3, out.width = "100%", fig.cap = "**Figure S3.** Posterior median differences and 95% credible intervals between the parameter values of each predator experience level predicted by the MDHGLM. The test is displayed on the y axis (i.e. whether the group of interest has either a greater or smaller value), and the parameter value is displayed on the x axis. Each panel represent the experience level groups that are being compared."}

knitr::include_graphics(
  here::here(
    "outputs", "04_outputs_figures",
    "appendix1_figureS3.png"
  )
)

```

```{r figS4, out.width = "100%", fig.cap = "**Figure S4.** Posterior median differences and 95% credible intervals in the correlations of players when they were advanced vs novice. The difference is displayed on the x axis and the parameter correlations are displayed on the y axis."}

knitr::include_graphics(
  here::here(
    "outputs", "04_outputs_figures",
    "appendix1_figureS4.png"
  )
)

```